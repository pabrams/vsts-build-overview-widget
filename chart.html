<!DOCTYPE html>
<html>

<head>
    <script src="scripts/VSS.SDK.min.js"></script>
    <style>
        #status {
            position: absolute;
            bottom: 10px;
            font-size: 0.70em;
            left: 0;
            right: 0;
            text-align: center;
        };

        #Chart-Container {
            background-color: lightyellow;
        }
    </style>
    <script type="text/javascript">
        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformStyles: true
        });
        VSS.require(["TFS/Dashboards/WidgetHelpers", "TFS/Build/RestClient", "Charts/Services"],
           function (WidgetHelpers, TFS_Build_WebApi, TFS_Charts) {
                VSS.register("widgetChart", function () {
                    console.log("registering widgetChart");
                    return {
                        load: function (widgetSettings) {
                            console.log("called load");
                            // const https = require(["node:https"],  http => {
                            const https = require("node:https");
                            console.log('http');
                            https.get("/api/measures/component?component=bdc-curam-benefit-group1&branch=dev-r2&metricKeys=coverage", 
                                res => {
                                    let data = [];
                                    const headerDate = res.headers && res.headers.date ? res.headers.date : 'no response date';
                                    console.log('Status Code:', res.statusCode);
                                    console.log('Date in Response header:', headerDate);

                                    res.on('data', chunk => {
                                        data.push(chunk);
                                    });
                                    res.on('end', () => {
                                        console.log('Response ended: ');
                                        const users = JSON.parse(Buffer.concat(data).toString());

                                        for(user of users) {
                                            console.log(`Got user with id: ${user.id}, name: ${user.name}`);
                                        }
                                    });
                                }
                            );
                            
                            console.log("load");
                            return WidgetHelpers.WidgetStatusHelper.Success();
                        },
                        reload: function (widgetSettings) {
                            console.log("reload");
                            return WidgetHelpers.WidgetStatusHelper.Success();
                        }
                    }
                });
                VSS.notifyLoadSucceeded();
            }
        );
    </script>
</head>

<body>
    <div class="widget">
        <h2 class="title"><a href="." title="tooltip" target="_blank">link</a></h2>
        <div id="status"></div>
        <div id="Chart-Container"></div>
    </div>
</body>

</html>